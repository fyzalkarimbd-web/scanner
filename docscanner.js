let dpRaw=new Image,dpCanvas=document.getElementById("dpSourceCanvas"),dpCtx=dpCanvas?dpCanvas.getContext("2d",{willReadFrequently:!0}):null,dpLoaded=!1,dpPoints=[],dpActivePoint=-1,isDocCropActive=!1,dpCroppedRatio=1;function openDocProcessorModal(){"function"==typeof setActiveMode&&setActiveMode("mode-doc-processor");var e=document.getElementById("docProcessorModal");e&&(e.style.display="flex",document.body.style.overflow="hidden")}function closeDocProcessorModal(){var e=document.getElementById("docProcessorModal");e&&(e.style.display="none",document.body.style.overflow="auto",fullResetDocProcessor())}function handleDocBoxClick(){dpLoaded||document.getElementById("dpFileInput").click()}function initDocProcessor(){dpCanvas&&(dpCanvas.width=dpRaw.width,dpCanvas.height=dpRaw.height,dpPoints=[{x:.1*dpCanvas.width,y:.1*dpCanvas.height},{x:.9*dpCanvas.width,y:.1*dpCanvas.height},{x:.9*dpCanvas.width,y:.9*dpCanvas.height},{x:.1*dpCanvas.width,y:.9*dpCanvas.height}],renderDocScreen())}function renderDocScreen(e=!1){if(!dpLoaded||!dpCtx)return;let t=document.getElementById("dp-sat").value,d=document.getElementById("dp-ct").value;dpCtx.clearRect(0,0,dpCanvas.width,dpCanvas.height),dpCtx.save(),dpCtx.filter=`saturate(${t}%) contrast(${d}%)`,dpCtx.drawImage(dpRaw,0,0),dpCtx.restore(),isDocCropActive&&!e&&(dpCtx.strokeStyle="#4f46e5",dpCtx.lineWidth=.006*dpCanvas.width,dpCtx.beginPath(),dpCtx.moveTo(dpPoints[0].x,dpPoints[0].y),dpPoints.forEach(e=>dpCtx.lineTo(e.x,e.y)),dpCtx.closePath(),dpCtx.stroke(),dpPoints.forEach((e,t)=>{dpCtx.fillStyle=t===dpActivePoint?"#ffff00":"#4f46e5",dpCtx.beginPath(),dpCtx.arc(e.x,e.y,.015*dpCanvas.width,0,2*Math.PI),dpCtx.fill(),dpCtx.strokeStyle="#fff",dpCtx.stroke()}))}function getDocCoords(e){let t=dpCanvas.getBoundingClientRect(),d=dpCanvas.width/t.width,n=dpCanvas.height/t.height,a=e.touches?e.touches[0].clientX:e.clientX,p=e.touches?e.touches[0].clientY:e.clientY;return{x:(a-t.left)*d,y:(p-t.top)*n}}async function confirmPerspectiveCrop(){if("undefined"!=typeof cv&&dpLoaded){renderDocScreen(!0);try{let e=cv.imread(dpCanvas),t=new cv.Mat,d=Math.hypot(dpPoints[1].x-dpPoints[0].x,dpPoints[1].y-dpPoints[0].y),n=Math.hypot(dpPoints[2].x-dpPoints[3].x,dpPoints[2].y-dpPoints[3].y),a=Math.max(d,n),p=Math.hypot(dpPoints[3].x-dpPoints[0].x,dpPoints[3].y-dpPoints[0].y),o=Math.hypot(dpPoints[2].x-dpPoints[1].x,dpPoints[2].y-dpPoints[1].y),i=Math.max(p,o);dpCroppedRatio=a/i;let l=cv.matFromArray(4,1,cv.CV_32FC2,[dpPoints[0].x,dpPoints[0].y,dpPoints[1].x,dpPoints[1].y,dpPoints[2].x,dpPoints[2].y,dpPoints[3].x,dpPoints[3].y]),s=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,a,0,a,i,0,i]),r=cv.getPerspectiveTransform(l,s);cv.warpPerspective(e,t,r,new cv.Size(a,i)),cv.imshow(dpCanvas,t),(dpRaw=new Image).onload=()=>{dpLoaded=!0,isDocCropActive=!1,dpCanvas.width=a,dpCanvas.height=i,renderDocScreen()},dpRaw.src=dpCanvas.toDataURL("image/jpeg",.95),e.delete(),t.delete(),r.delete(),l.delete(),s.delete()}catch(c){console.error(c)}}}async function applyMagicEffect(e){dpLoaded&&("bw"===e?(document.getElementById("dp-sat").value=0,document.getElementById("dp-ct").value=200,document.getElementById("v-dp-sat").innerText="0%",document.getElementById("v-dp-ct").innerText="200%"):"color"===e&&(document.getElementById("dp-sat").value=130,document.getElementById("dp-ct").value=200,document.getElementById("v-dp-sat").innerText="130%",document.getElementById("v-dp-ct").innerText="200%"),renderDocScreen())}function rotateDocImg(){if(!dpLoaded||!dpRaw.src)return;let e=document.createElement("canvas"),t=e.getContext("2d");e.width=dpRaw.height,e.height=dpRaw.width,t.translate(e.width/2,e.height/2),t.rotate(Math.PI/2),t.drawImage(dpRaw,-dpRaw.width/2,-dpRaw.height/2);let d=e.toDataURL("image/jpeg",.95);dpLoaded=!1,(dpRaw=new Image).onload=function(){dpLoaded=!0,dpCanvas.width=dpRaw.width,dpCanvas.height=dpRaw.height,dpPoints=[{x:.1*dpCanvas.width,y:.1*dpCanvas.height},{x:.9*dpCanvas.width,y:.1*dpCanvas.height},{x:.9*dpCanvas.width,y:.9*dpCanvas.height},{x:.1*dpCanvas.width,y:.9*dpCanvas.height}],isDocCropActive=!0,dpCtx.clearRect(0,0,dpCanvas.width,dpCanvas.height),setTimeout(()=>{renderDocScreen()},50)},dpRaw.src=d}function fullResetDocProcessor(){dpLoaded=!1,isDocCropActive=!1,dpActivePoint=-1,dpRaw=new Image,dpCtx&&dpCtx.clearRect(0,0,dpCanvas.width,dpCanvas.height),document.getElementById("dpFileInput").value="",document.getElementById("dpHint").style.display="block",dpCanvas.style.display="none",document.getElementById("dp-sat").value=100,document.getElementById("dp-ct").value=100,document.getElementById("v-dp-sat").innerText="100%",document.getElementById("v-dp-ct").innerText="100%"}function downloadDocResult(){if(!dpLoaded)return;let e=document.createElement("a");e.download="Doc_HD.jpg",e.href=dpCanvas.toDataURL("image/jpeg",.9),e.click()}function openDocPrintPreview(){dpLoaded&&(document.getElementById("dpFinalPrintImg").src=dpCanvas.toDataURL(),document.getElementById("docPrintModal").style.display="flex",document.getElementById("dp-p-w").value=4,document.getElementById("dp-p-h").value=(4/dpCroppedRatio).toFixed(2),updatePrintLayoutUI(),setupPrintInteraction())}function updatePrintLayoutUI(){let e=document.getElementById("dpDraggableWrap"),t=parseFloat(document.getElementById("dp-p-w").value),d=parseFloat(document.getElementById("dp-p-h").value),n=parseFloat(document.getElementById("dp-p-t").value),a=parseFloat(document.getElementById("dp-p-l").value);e.style.width=35*t+"px",e.style.height=35*d+"px",e.style.top=35*n+"px",e.style.left=35*a+"px"}function setupPrintInteraction(){let e=document.getElementById("dpDraggableWrap"),t=!1,d=!1,n,a,p,o,i,l=l=>{let s=l.touches?l.touches[0].clientX:l.clientX,r=l.touches?l.touches[0].clientY:l.clientY,c=e.getBoundingClientRect();s>c.right-25&&r>c.bottom-25?d=!0:t=!0,n=s,a=r,p=parseFloat(document.getElementById("dp-p-w").value),o=parseFloat(document.getElementById("dp-p-t").value),i=parseFloat(document.getElementById("dp-p-l").value),l.cancelable&&l.preventDefault()},s=e=>{if(!t&&!d)return;let l=e.touches?e.touches[0].clientX:e.clientX,s=e.touches?e.touches[0].clientY:e.clientY,r=(l-n)/35,c=(s-a)/35;if(d){let v=Math.max(.5,p+r);document.getElementById("dp-p-w").value=v.toFixed(2),document.getElementById("dp-p-h").value=(v/dpCroppedRatio).toFixed(2)}else t&&(document.getElementById("dp-p-l").value=(i+r).toFixed(2),document.getElementById("dp-p-t").value=(o+c).toFixed(2));updatePrintLayoutUI(),e.cancelable&&e.preventDefault()},r=()=>{t=!1,d=!1};e.onmousedown=l,e.ontouchstart=l,window.onmousemove=s,window.ontouchmove=s,window.onmouseup=r,window.ontouchend=r}function autoFitA4(){let e=7.5,t=e/dpCroppedRatio;t>10.5&&(e=(t=10.5)*dpCroppedRatio),document.getElementById("dp-p-w").value=e.toFixed(2),document.getElementById("dp-p-h").value=t.toFixed(2),document.getElementById("dp-p-l").value=((8.27-e)/2).toFixed(2),document.getElementById("dp-p-t").value=.5,updatePrintLayoutUI()}function generateDocPDF(){if(!window.jspdf)return;let{jsPDF:e}=window.jspdf,t=new e("p","in","a4"),d=parseFloat(document.getElementById("dp-p-w").value),n=parseFloat(document.getElementById("dp-p-h").value),a=parseFloat(document.getElementById("dp-p-t").value),p=parseFloat(document.getElementById("dp-p-l").value);t.addImage(dpCanvas.toDataURL("image/jpeg",1),"JPEG",p,a,d,n),t.save("A4_Document.pdf")}document.getElementById("dpFileInput").addEventListener("change",function(e){let t=e.target.files[0];if(!t)return;let d=new FileReader;d.onload=e=>{let t=new Image;t.onload=()=>{let e=Math.min(1,1600/Math.max(t.width,t.height)),d=document.createElement("canvas");d.width=t.width*e,d.height=t.height*e;let n=d.getContext("2d",{alpha:!1});n.drawImage(t,0,0,d.width,d.height),(dpRaw=new Image).onload=()=>{dpLoaded=!0,isDocCropActive=!0,document.getElementById("dpHint").style.display="none",dpCanvas.style.display="block",initDocProcessor()},dpRaw.src=d.toDataURL("image/jpeg",.9)},t.src=e.target.result},d.readAsDataURL(t)}),dpCanvas.onmousedown=dpCanvas.ontouchstart=e=>{if(!dpLoaded||!isDocCropActive)return;let t=getDocCoords(e);dpPoints.forEach((e,d)=>{Math.hypot(e.x-t.x,e.y-t.y)<.08*dpCanvas.width&&(dpActivePoint=d)})},window.addEventListener("mousemove",e=>{if(-1===dpActivePoint)return;let t=getDocCoords(e);dpPoints[dpActivePoint]={x:t.x,y:t.y},renderDocScreen()}),window.addEventListener("touchmove",e=>{if(-1===dpActivePoint)return;let t=getDocCoords(e);dpPoints[dpActivePoint]={x:t.x,y:t.y},renderDocScreen(),e.cancelable&&e.preventDefault()},{passive:!1}),window.addEventListener("mouseup",()=>dpActivePoint=-1),window.addEventListener("touchend",()=>dpActivePoint=-1),["dp-p-w","dp-p-h","dp-p-t","dp-p-l"].forEach(e=>{document.getElementById(e).addEventListener("input",updatePrintLayoutUI)}),["dp-p-w","dp-p-h","dp-p-t","dp-p-l"].forEach(e=>{document.getElementById(e).addEventListener("input",updatePrintLayoutUI)}),["dp-sat","dp-ct"].forEach(e=>{document.getElementById(e).addEventListener("input",t=>{document.getElementById("v-"+e).innerText=t.target.value+"%",renderDocScreen()})});
