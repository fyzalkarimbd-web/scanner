function openCropModal(){setActiveMode("mode-crop-tool"),document.getElementById("imageCropModal").style.display="flex",document.body.style.overflow="hidden"}function closeCropModal(){document.getElementById("imageCropModal").style.display="none",document.body.style.overflow="auto",performDeleteCP(),resetSizeSelectorCP()}function resetSizeSelectorCP(){targetW_CP=0,targetH_CP=0,currentSizeName_CP="Dynamic",document.querySelectorAll(".size-card").forEach(e=>e.classList.remove("selected"));let e=document.querySelector(".size-grid .size-card");e&&e.classList.add("selected"),switchTab_CP("photo")}
const PHOTO_DATA_CP=[{name:"Passport (BD)",w:1.5,h:1.9,u:"in"},{name:"Passport (USA/India)",w:2,h:2,u:"in"},{name:"Stamp Size (BD)",w:22,h:27,u:"mm"},{name:"Stamp (1x1.25)",w:1,h:1.25,u:"in"},{name:"3R Photo (New)",w:3.5,h:5,u:"in"},{name:"Joint Photo",w:1.9,h:1.5,u:"in"},{name:"Album Photo",w:3.5,h:5,u:"in"},{name:"Original NID",w:3.3,h:2.1,u:"in"},{name:"Smart Card/NID",w:3.37,h:2.12,u:"in"},{name:"Big NID",w:3.7,h:2.29,u:"in"},{name:"4R Photo",w:4,h:6,u:"in"},{name:"5R Photo",w:5,h:7,u:"in"},{name:"6R Photo",w:6,h:8,u:"in"},{name:"8R Photo",w:8,h:10,u:"in"},{name:"8x12 Photo",w:8,h:12,u:"in"},{name:"10R Photo",w:10,h:12,u:"in"},{name:"11x14 Photo",w:11,h:14,u:"in"},{name:"12x18 Photo",w:12,h:18,u:"in"},{name:"Square Photo",w:5,h:5,u:"in"},{name:"Wallet Photo",w:2.5,h:3.5,u:"in"}],PAPER_DATA_CP=[{name:"A4 Paper",w:8.27,h:11.69,u:"in"},{name:"A3 Paper",w:11.69,h:16.54,u:"in"},{name:"A5 Paper",w:5.83,h:8.27,u:"in"},{name:"Letter",w:8.5,h:11,u:"in"},{name:"Legal",w:8.5,h:14,u:"in"},{name:"Tabloid",w:11,h:17,u:"in"},{name:"Executive",w:7.25,h:10.5,u:"in"},{name:"B4 Size",w:9.84,h:13.9,u:"in"},{name:"B5 Size",w:6.93,h:9.84,u:"in"},{name:"Folio Size",w:8.5,h:13,u:"in"},{name:"Statement",w:5.5,h:8.5,u:"in"},{name:"Ledger",w:17,h:11,u:"in"}];
let targetW_CP=0,targetH_CP=0,currentSizeName_CP="Dynamic",isImageLoadedCP=!1,finalCanvasCP=null,imgElementCP=new Image,canvasCP=document.getElementById("main-canvas"),ctxCP=canvasCP?canvasCP.getContext("2d", {willReadFrequently: true}):null,pointsCP=[],activePointCP=-1,isDraggingCP=!1;const checkCV_CP=setInterval(()=>{if("undefined"!=typeof cv&&cv.Mat){let e=document.getElementById("cp-status");e&&(e.innerHTML='<i class="fa-solid fa-circle-check"></i> System Ready.'),initSizesCP(),clearInterval(checkCV_CP)}},300);
function initSizesCP(){let e=document.getElementById("photo-sizes"),s=document.getElementById("paper-sizes");e&&s&&(e.innerHTML='<div class="size-card selected" onclick="setSize_CP(0, 0, \'Dynamic\', this)"><strong>Dynamic</strong><span>Free Ratio</span></div>',s.innerHTML="",PHOTO_DATA_CP.forEach(s=>e.innerHTML+=`<div class="size-card" onclick="setSize_CP(${s.w}, ${s.h}, '${s.name}', this, '${s.u}')"><strong>${s.name}</strong><span>${s.w}x${s.h} ${s.u}</span></div>`),PAPER_DATA_CP.forEach(e=>s.innerHTML+=`<div class="size-card" onclick="setSize_CP(${e.w}, ${e.h}, '${e.name}', this, '${e.u}')"><strong>${e.name}</strong><span>${e.w}x${e.h} ${e.u}</span></div>`))}function switchTab_CP(e){document.getElementById("tab-photo").classList.toggle("active","photo"===e),document.getElementById("tab-paper").classList.toggle("active","paper"===e),document.getElementById("photo-sizes").style.display="photo"===e?"grid":"none",document.getElementById("paper-sizes").style.display="paper"===e?"grid":"none"}function setSize_CP(e,s,t,i,n){if(document.querySelectorAll(".size-card").forEach(e=>e.classList.remove("selected")),i.classList.add("selected"),currentSizeName_CP=t,0===e){targetW_CP=0,targetH_CP=0;return}targetW_CP="mm"===n?e/25.4:e,targetH_CP="mm"===n?s/25.4:s}
const canvasWrapCP=document.getElementById("canvas-container-cp"),btnCropCP=document.getElementById("crop-btn-cp"),btnRotateCP=document.getElementById("rotate-btn-cp"),btnDeleteCP=document.getElementById("delete-btn-cp");function setupCanvasCP(){if(!canvasCP)return;let e=Math.min(.9*window.innerWidth,800)/imgElementCP.width;canvasCP.width=imgElementCP.width*e,canvasCP.height=imgElementCP.height*e,pointsCP=[{x:.1*canvasCP.width,y:.1*canvasCP.height},{x:.9*canvasCP.width,y:.1*canvasCP.height},{x:.9*canvasCP.width,y:.9*canvasCP.height},{x:.1*canvasCP.width,y:.9*canvasCP.height}],drawCP()}function drawCP(){imgElementCP.src&&ctxCP&&(ctxCP.drawImage(imgElementCP,0,0,canvasCP.width,canvasCP.height),ctxCP.beginPath(),ctxCP.strokeStyle="#4f46e5",ctxCP.lineWidth=2,ctxCP.moveTo(pointsCP[0].x,pointsCP[0].y),pointsCP.forEach(e=>ctxCP.lineTo(e.x,e.y)),ctxCP.closePath(),ctxCP.stroke(),pointsCP.forEach((e,t)=>{ctxCP.beginPath(),ctxCP.fillStyle=t===activePointCP?"#ffff00":"rgba(79, 70, 229, 0.9)",ctxCP.arc(e.x,e.y,13,0,2*Math.PI),ctxCP.fill(),ctxCP.strokeStyle="#fff",ctxCP.lineWidth=3,ctxCP.stroke()}))}document.getElementById("drop-zone-cp")&&(document.getElementById("drop-zone-cp").onclick=()=>document.getElementById("file-input-cp").click()),document.getElementById("file-input-cp")&&(document.getElementById("file-input-cp").onchange=e=>{let t=e.target.files[0];if(!t)return;let n=new FileReader;n.onload=e=>{let t=new Image;t.onload=()=>{let e=t.width,n=t.height;if(e>2200||n>2200){let i=Math.min(2200/e,2200/n);e*=i,n*=i}let a=document.createElement("canvas");a.width=e,a.height=n,a.getContext("2d").drawImage(t,0,0,e,n),imgElementCP.onload=()=>{isImageLoadedCP=!0,setupCanvasCP(),canvasWrapCP&&(canvasWrapCP.style.display="inline-block"),[btnCropCP,btnRotateCP,btnDeleteCP].forEach(e=>{e&&e.classList.remove("locked")});let e=document.getElementById("cp-status");e&&(e.innerHTML='<i class="fa-solid fa-crosshairs"></i> Adjust points and click Crop.')},imgElementCP.src=a.toDataURL("image/jpeg",.95)},t.src=e.target.result},n.readAsDataURL(t)});
const magCanvasCP=document.getElementById("magnifier-cp"),magCtxCP=magCanvasCP?magCanvasCP.getContext("2d"):null;function getMousePosCP(t){let e=canvasCP.getBoundingClientRect(),a=t.touches?t.touches[0].clientX:t.clientX,C=t.touches?t.touches[0].clientY:t.clientY;return{x:(a-e.left)*(canvasCP.width/e.width),y:(C-e.top)*(canvasCP.height/e.height)}}const handleMoveCP=t=>{if(!isDraggingCP)return;let e=getMousePosCP(t);pointsCP[activePointCP]={x:Math.max(0,Math.min(canvasCP.width,e.x)),y:Math.max(0,Math.min(canvasCP.height,e.y))},requestAnimationFrame(()=>{drawCP(),updateMagnifierCP(pointsCP[activePointCP])}),t.cancelable&&t.preventDefault()};function updateMagnifierCP(t){if(!magCanvasCP||!magCtxCP||!imgElementCP||!canvasCP)return;150!==magCanvasCP.width&&(magCanvasCP.width=150,magCanvasCP.height=150),magCanvasCP.style.display="block";let e=canvasCP.width,a=canvasCP.height,C="50%",n="50%",s=t.x/e,g=t.y/a;s>.3&&s<.7&&g>.3&&g<.7&&(C=s<.5?"85%":"15%",n=g<.5?"85%":"15%"),magCanvasCP.style.left=C,magCanvasCP.style.top=n,magCanvasCP.style.transform="translate(-50%, -50%)";let i=imgElementCP.width/e,m=imgElementCP.height/a,o=t.x*i,P=t.y*m,$=o-25,l=P-25;$<0&&($=0),l<0&&(l=0),$+50>imgElementCP.width&&($=imgElementCP.width-50),l+50>imgElementCP.height&&(l=imgElementCP.height-50),magCtxCP.clearRect(0,0,150,150),magCtxCP.imageSmoothingEnabled=!1,magCtxCP.drawImage(imgElementCP,$,l,50,50,0,0,150,150);let h=(o-$)*3,d=(P-l)*3;magCtxCP.lineWidth=1,magCtxCP.strokeStyle="rgba(255, 0, 0, 0.9)",magCtxCP.beginPath(),magCtxCP.moveTo(h,0),magCtxCP.lineTo(h,150),magCtxCP.stroke(),magCtxCP.beginPath(),magCtxCP.moveTo(0,d),magCtxCP.lineTo(150,d),magCtxCP.stroke(),magCtxCP.fillStyle="rgba(255, 255, 0, 0.5)",magCtxCP.fillRect(h-4,d-4,8,8)}canvasCP&&(canvasCP.addEventListener("mousedown",t=>{let e=getMousePosCP(t);pointsCP.forEach((t,a)=>{45>Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)&&(activePointCP=a,isDraggingCP=!0)})}),canvasCP.addEventListener("touchstart",t=>{let e=getMousePosCP(t);pointsCP.forEach((t,a)=>{50>Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)&&(activePointCP=a,isDraggingCP=!0)})},{passive:!1})),window.addEventListener("mousemove",handleMoveCP),window.addEventListener("mouseup",()=>{isDraggingCP=!1,activePointCP=-1,magCanvasCP&&(magCanvasCP.style.display="none")}),window.addEventListener("touchmove",handleMoveCP,{passive:!1}),window.addEventListener("touchend",()=>{isDraggingCP=!1,magCanvasCP&&(magCanvasCP.style.display="none")});
function checkAndAction_CP(e){if(!isImageLoadedCP){ showAlert("Please upload an image first!"); return; }"crop"===e&&performCropCP(),"rotate"===e&&performRotateCP(),"delete"===e&&performDeleteCP()}function performCropCP(){btnCropCP.innerHTML='<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...',setTimeout(()=>{let e=cv.imread(imgElementCP),t=new cv.Mat,o=imgElementCP.width/canvasCP.width,a=imgElementCP.height/canvasCP.height,i=pointsCP.map(e=>({x:e.x*o,y:e.y*a})),r=targetW_CP>0?300*targetW_CP:Math.max(Math.hypot(i[1].x-i[0].x,i[1].y-i[0].y),Math.hypot(i[2].x-i[3].x,i[2].y-i[3].y)),n=targetH_CP>0?300*targetH_CP:Math.max(Math.hypot(i[3].x-i[0].x,i[3].y-i[0].y),Math.hypot(i[2].x-i[1].x,i[2].y-i[1].y)),l=cv.matFromArray(4,1,cv.CV_32FC2,[i[0].x,i[0].y,i[1].x,i[1].y,i[2].x,i[2].y,i[3].x,i[3].y]),d=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,r,0,r,n,0,n]),c=cv.getPerspectiveTransform(l,d);cv.warpPerspective(e,t,c,new cv.Size(Math.round(r),Math.round(n))),finalCanvasCP=document.createElement("canvas"),cv.imshow(finalCanvasCP,t),document.getElementById("cp-preview-img").src=finalCanvasCP.toDataURL("image/png"),document.getElementById("size-info-cp").innerHTML=`<i class="fa-solid fa-circle-info"></i> Format: ${currentSizeName_CP} | Res: ${Math.round(r)}x${Math.round(n)} px`,document.getElementById("preview-section-cp").style.display="block",btnCropCP.innerHTML='<i class="fa-solid fa-crop-simple"></i> Straighten & Crop',document.getElementById("preview-section-cp").scrollIntoView({behavior:"smooth"}),e.delete(),t.delete(),c.delete(),l.delete(),d.delete()},50)}function downloadImage_CP(e){if(!finalCanvasCP)return;let t=document.createElement("a");t.download=`Cropped_${currentSizeName_CP.replace(/ /g,"_")}.${e}`,t.href=finalCanvasCP.toDataURL("png"===e?"image/png":"image/jpeg",1),t.click()}function downloadPDF_CP(){if(!finalCanvasCP){ showAlert("Please crop the image first!"); return; }try{let{jsPDF:e}=window.jspdf,t=finalCanvasCP.width/11.81,o=finalCanvasCP.height/11.81,a=new e({orientation:t>o?"l":"p",unit:"mm",format:[t,o],compress:!0}),i=finalCanvasCP.toDataURL("image/jpeg",.95);a.addImage(i,"JPEG",0,0,t,o);let r=`Cropped_${currentSizeName_CP.replace(/ /g,"_")}.pdf`,n=a.output("blob"),l=URL.createObjectURL(n),d=document.createElement("a");d.href=l,d.download=r,document.body.appendChild(d),d.click(),document.body.removeChild(d),setTimeout(()=>URL.revokeObjectURL(l),100)}catch(c){alert("Failed to download PDF.")}}function performRotateCP(){let e=document.createElement("canvas"),t=e.getContext("2d");e.width=imgElementCP.height,e.height=imgElementCP.width,t.translate(e.width/2,e.height/2),t.rotate(Math.PI/2),t.drawImage(imgElementCP,-imgElementCP.width/2,-imgElementCP.height/2),imgElementCP.src=e.toDataURL("image/jpeg",.95),imgElementCP.onload=()=>{setupCanvasCP()}}function performDeleteCP(){imgElementCP=new Image,document.getElementById("file-input-cp").value="",isImageLoadedCP=!1,canvasWrapCP&&(canvasWrapCP.style.display="none"),finalCanvasCP=null,[btnCropCP,btnRotateCP,btnDeleteCP].forEach(e=>{e&&e.classList.add("locked")}),document.getElementById("preview-section-cp").style.display="none"}
